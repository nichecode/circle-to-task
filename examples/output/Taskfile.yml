version: "3"
tasks:
    build:
        desc: 'Task converted from CircleCI job: build'
        cmds:
            - git checkout HEAD
            - task build-app ENVIRONMENT=production
            - mkdir -p ./workspace && cp -r [dist/*] ./workspace/
        deps:
            - install-deps
    build-app:
        desc: Build the application
        cmds:
            - npm run build:{{.ENVIRONMENT}}
            - mkdir -p ./artifacts && cp -r dist ./artifacts/
        vars:
            ENVIRONMENT: '{{.ENVIRONMENT | default "production"}}'
    ci-local:
        desc: Run full CI pipeline locally (where possible)
        cmds:
            - echo 'Running local CI simulation...'
            - 'echo ''Note: This runs the build logic, but skips server-only features'''
        deps:
            - setup-local
    clean:
        desc: Clean local build artifacts
        cmds:
            - rm -rf ./workspace ./artifacts ./test-results
            - echo 'Cleaned local CircleCI simulation directories'
    deploy:
        desc: 'Task converted from CircleCI job: deploy'
        cmds:
            - git checkout HEAD
            - echo 'Using local workspace if available'
            - npm run deploy:prod
    install-deps:
        desc: Install Node.js dependencies
        cmds:
            - npm install
            - npm ci --cache .npm --prefer-offline
    run-tests:
        desc: Run tests with coverage
        cmds:
            - npm test
            - 'echo ''Custom step not converted: when'''
        vars:
            COVERAGE: '{{.COVERAGE | default "false"}}'
    setup:
        desc: 'Task converted from CircleCI job: setup'
        cmds:
            - git checkout HEAD
        deps:
            - install-deps
    setup-local:
        desc: Setup local environment for CircleCI simulation
        cmds:
            - mkdir -p ./workspace ./artifacts ./test-results
            - echo 'Local CircleCI directories created'
            - 'echo ''Note: Some steps are CircleCI-server only and will be skipped'''
    test:
        desc: 'Task converted from CircleCI job: test'
        cmds:
            - git checkout HEAD
            - task run-tests COVERAGE=true
        deps:
            - install-deps
